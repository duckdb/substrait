# name: test/sql/test_substrait_parquet.test
# description: Test get_substrait and from_substrait from parquet
# group: [substrait]

require substrait

statement ok
PRAGMA enable_verification

require parquet

statement ok
CALL get_substrait('SELECT sum(l_extendedprice * l_discount) as revenue FROM parquet_scan(''data/parquet-testing/lineitem-top10000.gzip.parquet'')')

# Test from a parquet view

statement ok
CREATE TABLE lineitem_parquet AS SELECT * FROM parquet_scan('data/parquet-testing/lineitem-top10000.gzip.parquet')

query I
CALL get_substrait('SELECT sum(l_extendedprice * l_discount) as revenue FROM lineitem_parquet')
----
\x0A\x5C\x08\x01\x12Xhttps://github.com/substrait-io/substrait/blob/main/extensions/functions_arithmetic.yaml\x12\x1A\x1A\x18\x08\x01\x10\x01\x1A\x12multiply:fp64_fp64\x12\x10\x1A\x0E\x08\x01\x10\x02\x1A\x08sum:fp64\x1A\xB3\x03\x12\xB0\x03\x0A\xA4\x03:\xA1\x03\x12\x94\x03\x22\x91\x03\x12\xD8\x02\x0A\xD5\x02\x12\xB0\x02\x0A\x0Al_orderkey\x0A\x09l_partkey\x0A\x09l_suppkey\x0A\x0Cl_linenumber\x0A\x0Al_quantity\x0A\x0Fl_extendedprice\x0A\x0Al_discount\x0A\x05l_tax\x0A\x0Cl_returnflag\x0A\x0Cl_linestatus\x0A\x0Al_shipdate\x0A\x0Cl_commitdate\x0A\x0Dl_receiptdate\x0A\x0El_shipinstruct\x0A\x0Al_shipmode\x0A\x09l_comment\x12b\x0A\x04:\x02\x10\x01\x0A\x04:\x02\x10\x01\x0A\x04:\x02\x10\x01\x0A\x04*\x02\x10\x01\x0A\x04*\x02\x10\x01\x0A\x04Z\x02\x10\x01\x0A\x04Z\x02\x10\x01\x0A\x04Z\x02\x10\x01\x0A\x04b\x02\x10\x01\x0A\x04b\x02\x10\x01\x0A\x04b\x02\x10\x01\x0A\x04b\x02\x10\x01\x0A\x04b\x02\x10\x01\x0A\x04b\x02\x10\x01\x0A\x04b\x02\x10\x01\x0A\x04b\x02\x10\x01\x18\x02\x22\x0C\x0A\x08\x0A\x02\x08\x05\x0A\x02\x08\x06\x10\x01:\x12\x0A\x10lineitem_parquet\x1A\x00\x222\x0A0\x08\x02*\x04Z\x02\x10\x01:&\x1A$\x1A\x22\x08\x01\x1A\x04Z\x02\x10\x01\x22\x0A\x1A\x08\x12\x06\x0A\x02\x12\x00\x22\x00\x22\x0C\x1A\x0A\x12\x08\x0A\x04\x12\x02\x08\x01\x22\x00\x1A\x08\x12\x06\x0A\x02\x12\x00\x22\x00\x12\x07revenue2\x0A\x100*\x06DuckDB

statement ok
DROP TABLE lineitem_parquet;

statement ok
CREATE VIEW lineitem_parquet AS SELECT * FROM parquet_scan('data/parquet-testing/lineitem-top10000.gzip.parquet')

# Verify that we can re-use the query plan on a view instead
query I
CALL from_substrait('\x12\x07\x1A\x05\x10\x01\x1A\x01*\x12\x09\x1A\x07\x10\x02\x1A\x03sum\x1A\xC7\x03\x12\xC4\x03\x0A\xB8\x03:\xB5\x03\x12\xA8\x03\x22\xA5\x03\x12\xEC\x02\x0A\xE9\x02\x12\xC4\x02\x0A\x0Al_orderkey\x0A\x09l_partkey\x0A\x09l_suppkey\x0A\x0Cl_linenumber\x0A\x0Al_quantity\x0A\x0Fl_extendedprice\x0A\x0Al_discount\x0A\x05l_tax\x0A\x0Cl_returnflag\x0A\x0Cl_linestatus\x0A\x0Al_shipdate\x0A\x0Cl_commitdate\x0A\x0Dl_receiptdate\x0A\x0El_shipinstruct\x0A\x0Al_shipmode\x0A\x09l_comment\x12v\x0A\x04:\x02\x10\x01\x0A\x04:\x02\x10\x01\x0A\x04:\x02\x10\x01\x0A\x02*\x00\x0A\x02*\x00\x0A\x04Z\x02\x10\x01\x0A\x04Z\x02\x10\x01\x0A\x04Z\x02\x10\x01\x0A\x07\xB2\x01\x04\x08\x01\x18\x01\x0A\x07\xB2\x01\x04\x08\x01\x18\x01\x0A\x07\xB2\x01\x04\x08\x0A\x18\x01\x0A\x07\xB2\x01\x04\x08\x0A\x18\x01\x0A\x07\xB2\x01\x04\x08\x0A\x18\x01\x0A\x07\xB2\x01\x04\x08\x11\x18\x01\x0A\x07\xB2\x01\x04\x08\x07\x18\x01\x0A\x07\xB2\x01\x04\x08+\x18\x01\x18\x02\x22\x0C\x0A\x08\x0A\x02\x08\x05\x0A\x02\x08\x06\x10\x01:\x12\x0A\x10lineitem_parquet\x1A\x00\x222\x0A0\x08\x02*\x04Z\x02\x10\x01:&\x1A$\x1A\x22\x08\x01\x1A\x04Z\x02\x10\x01\x22\x0A\x1A\x08\x12\x06\x0A\x02\x12\x00\x22\x00\x22\x0C\x1A\x0A\x12\x08\x0A\x04\x12\x02\x08\x01\x22\x00\x1A\x08\x12\x06\x0A\x02\x12\x00\x22\x00\x12\x07revenue2\x0A\x100*\x06DuckDB'::BLOB)
----
19107076.83379995

# Test Globbing
statement ok
CALL get_substrait('select * from parquet_scan(''data/parquet-testing/glob*/t?.parquet'') order by i')

statement error
CALL get_substrait('select * from parquet_scan('''') order by i')
----
No files found that match the pattern ""

